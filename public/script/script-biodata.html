<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-dark@5/dark.css"
/>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.js"></script>
<script>
  let isCellLocked = true;
  let arrayNewData = [];
  console.log("Script is running...");

  document.querySelectorAll("td").forEach(function (cell) {
    cell.addEventListener("dblclick", function () {
      if (isCellLocked) {
        return;
      }

      let buttonDelete = cell.querySelector(".btn-delete");
      let rowID = cell.parentElement.id;
      let nis = rowID.split("-")[1];

      let isEditableCell =
        cell.classList.contains("editable-type-text") ||
        cell.classList.contains("editable-type-date") ||
        cell.classList.contains("editable-type-number") ||
        cell.classList.contains("editable-type-select");

      if (isEditableCell) {
        if (buttonDelete) {
          buttonDelete.remove();
        }
        // Save current text (excluding button)
        let currentText = cell.textContent.trim();

        let input = document.createElement("input");
        let select = document.createElement("select");

        let isCellTypeText = cell.classList.contains("editable-type-text");
        let isCellTypeDate = cell.classList.contains("editable-type-date");
        let isCellTypeNumber = cell.classList.contains("editable-type-number");
        let isCellTypeSelect = cell.classList.contains("editable-type-select");

        if (isCellTypeText) {
          input.type = "text";
        } else if (isCellTypeDate) {
          input.type = "date";
        } else if (isCellTypeNumber) {
          input.type = "number";
        } else if (isCellTypeSelect) {
          input = select;

          const status = ["SANTRI AKTIF", "LULUS", "BOYONG"];
          // Add options to select
          for (let i = 0; i < status.length; i++) {
            console.log(status[i]);
            input.innerHTML += `<option value="${status[i]}">${status[i]}</option>`;
          }
        }

        if (cell.classList.contains("editable-type-date")) {
          let cellDate = replaceDateToSystemFormat(currentText);
          cellDate = cellDate.setDate(cellDate.getDate() + 1);
          cellDate = new Date(cellDate).toISOString().split("T")[0];

          input.value = cellDate;
          currentText = cellDate;
        } else {
          input.value = currentText;
        }

        cell.innerHTML = "";
        cell.appendChild(input);

        input.focus();

        input.addEventListener("blur", () => {
          input.remove();
          addNewValue();
          if (
            input.value.toLocaleUpperCase() !== currentText.toLocaleUpperCase()
          ) {
            changeStyleCell();
            displaySaveButton();
          }
        });

        input.addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            input.remove();
            addNewValue();
            if (
              input.value.toLocaleUpperCase() !==
              currentText.toLocaleUpperCase()
            ) {
              changeStyleCell();
              displaySaveButton();
            }
          }
        });

        function changeStyleCell() {
          cell.style.backgroundColor = "#FCDE70";
          cell.style.transition = "background-color 0.5s";
          cell.style.color = "black";
          cell.style.fontWeight = "bold";
          cell.style.textShadow = "0 0 5px white";
        }

        function addNewValue() {
          var newText = input.value;
          if (isCellTypeDate) {
            newText = new Date(newText).toLocaleString("id-ID", {
              year: "numeric",
              month: "long",
              day: "numeric",
            });
          } else {
            newText = newText.toUpperCase();
          }

          cell.innerHTML = newText;
          getNewDataStudent(nis);

          if (buttonDelete) {
            cell.innerHTML =
              newText +
              `<button
                  class="submit btn-delete position-absolute end-0"
                  onclick="stylingDeletedRow(this.id)"
                >
                  <span class="material-symbols-outlined">
                    delete
                  </span>
              </button>`;
          }
        }

        function displaySaveButton() {
          var saveButton = document.querySelector(".save");
          saveButton.classList.remove("d-none");
          saveButton.classList.add("d-flex");
        }
      } else {
        console.log("This cell is not editable.");
      }
    });
  });

  function getNewDataStudent(nis) {
    var row = document.getElementById(`student-${nis}`);
    var cells = row.children;
    var newData = {
      nis: nis,
      newNIS: cells[0].outerText
        .replace("delete\n", "")
        .replace("\ndelete")
        .trim(),
      fullName: cells[1].outerText,
      cityOfBirth: cells[3].outerText,
      dateOfBirth: cells[4].outerText,
      fatherName: cells[5].outerText,
      motherName: cells[6].outerText,
      guardianName: cells[7].outerText,
      status: cells[8].outerText,
      address: cells[9].outerText,
    };

    addNewData(nis, newData);
  }

  function addNewData(nis, newData) {
    if (arrayNewData.length === 0) {
      arrayNewData.push(newData);
      return;
    }

    for (let i = 0; i < arrayNewData.length + 1; i++) {
      var priveousNIS = parseInt(nis);
      var newNIS = parseInt(arrayNewData[i]?.nis);

      var isSameNIS = priveousNIS === newNIS;
      var isLastIndex = i === arrayNewData.length;

      if (isSameNIS) {
        arrayNewData[i] = newData;
        break;
      } else if (isLastIndex) {
        arrayNewData.push(newData);
        break;
      }
    }

    console.log(arrayNewData);
    console.log(JSON.stringify(arrayNewData));
  }

  function createInputAtFormUpdate() {
    const form = document.getElementById("form-updateData");

    let arrayNewDataInput = document.createElement("input");
    arrayNewDataInput.type = "hidden";
    arrayNewDataInput.name = "biodata";
    arrayNewDataInput.value = JSON.stringify(arrayNewData);
    form.appendChild(arrayNewDataInput);
  }

  function submitFormUpdate() {
    createInputAtFormUpdate();

    const form = document.getElementById("form-updateData");
    form.submit();
  }

  function deleteData(nis) {
    stylingDeletedRow(nis);

    setTimeout(() => {
      Swal.fire({
        title: "Anda Yakin ?",
        text: "data yang terhapus tidak akan bisa dikembalikan!",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#3085d6",
        cancelButtonColor: "#d33",
        confirmButtonText: "Yas, tetap hapus!",
      }).then((result) => {
        if (result.isConfirmed) {
          Swal.fire({
            title: "Data Terhapus!",
            text: "Data anda telah dihapus.",
            icon: "success",
          }).then((result) => {
            console.log(result);
            createInputAtFormDelete(nis);

            const form = document.getElementById("form-deleteData");
            form.submit();
          });
        } else {
          removeStyleDeletedRow(nis);
        }
      });
    }, 500);
  }

  function createInputAtFormDelete(nis) {
    const form = document.getElementById("form-deleteData");

    let input = document.createElement("input");
    input.type = "hidden";
    input.name = "nis";
    input.value = nis;

    form.appendChild(input);
  }

  function stylingDeletedRow(nis) {
    const row = document.getElementById(`student-${nis}`);

    row.style.textDecorationLine = "line-through";
    row.style.textDecorationThickness = "2px";
    row.style.transition = "text-decoration 0.5s";
    row.style.textDecorationColor = "red";
  }

  function removeStyleDeletedRow(nis) {
    const row = document.getElementById(`student-${nis}`);

    row.style.textDecorationLine = "none";
  }

  function replaceDateToSystemFormat(indonesianDate) {
    if (new Date(indonesianDate) != "Invalid Date") {
      console.log(new Date(indonesianDate));
      return new Date(indonesianDate);
    } else {
      const month = [
        "januari",
        "februari",
        "maret",
        "april",
        "mei",
        "juni",
        "juli",
        "agustus",
        "september",
        "oktober",
        "november",
        "desember",
      ];

      indonesianDate = indonesianDate.split(" ");
      const day = indonesianDate[0];
      const monthIndex = month.indexOf(indonesianDate[1].toLowerCase());
      const year = indonesianDate[2];

      return new Date(year, monthIndex, day);
    }
  }

  function undo() {
    location.reload();
  }

  function unlockCell() {
    isCellLocked = !isCellLocked;

    var buttomUnlock = document.getElementById("unlock");
    var iconUnlock = buttomUnlock.querySelectorAll("span");
    var buttonDelete = document.querySelectorAll(".btn-delete");

    if (isCellLocked) {
      iconUnlock[0].innerHTML = "lock";
      iconUnlock[1].innerHTML = "Cell Terkunci";
      buttomUnlock.classList.remove("btn-danger");
      buttomUnlock.classList.add("btn-success");
      buttonDelete.forEach(function (button) {
        button.parentElement.parentElement.addEventListener(
          "mouseenter",
          function () {
            button.style.display = "none";
          }
        );

        button.parentElement.parentElement.addEventListener(
          "mouseleave",
          function () {
            button.style.display = "none";
          }
        );
      });
    } else {
      iconUnlock[0].innerHTML = "lock_open_right";
      iconUnlock[1].innerHTML = "Cell Terbuka";
      buttomUnlock.classList.remove("btn-success");
      buttomUnlock.classList.add("btn-danger");
      buttonDelete.forEach(function (button) {
        button.parentElement.parentElement.addEventListener(
          "mouseenter",
          function () {
            button.style.display = "inline";
          }
        );

        button.parentElement.parentElement.addEventListener(
          "mouseleave",
          function () {
            button.style.display = "none";
          }
        );
      });
    }
  }

  var currentLocation = document.location.pathname;
  var updateLocation = "/admin/biodata/update";
  var deleteLocation = "/admin/biodata/delete";

  if (currentLocation == updateLocation || currentLocation == deleteLocation) {
    deleteLockButton();
  }
</script>
